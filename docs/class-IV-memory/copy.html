<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>11.1. Copying objects &#8212; CISC 187 Course Reader Overview</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/matrixeq.css?v=58BC228F" />
    <link rel="stylesheet" type="text/css" href="../_static/CodeChat.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/handsontable@7.2.2/dist/handsontable.full.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/webgldemo.css?v=B36B48D" />
    <link rel="stylesheet" type="text/css" href="../_static/webglinteractive.css?v=910DF1E1" />
    <link rel="stylesheet" type="text/css" href="../_static/accessibility.css?v=DB047029" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-3.4.1/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/presenter_mode.css?v=9FF1320F" />
    <link rel="stylesheet" type="text/css" href="../_static/jquery-ui-1.10.3.custom.min.css?v=97E0178A" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/user-highlights.css?v=A2326E52" />
    <link rel="stylesheet" type="text/css" href="../_static/runestone-custom-sphinx-bootstrap.css?v=5.0.8" />
    <link rel="stylesheet" type="text/css" href="../_static/theme-overrides.css?v=2DAFE138" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/pytutor-embed.bundle.js?v=268B5C04"></script>
    <script src="../_static/matrixeq.js?v=D64CFA5A"></script>
    <script src="../_static/animationbase.js?v=A043C3A7"></script>
    <script src="../_static/html4css1.css?v=4D8F3FB4"></script>
    <script src="../_static/jquery.highlight.js?v=F1C496C8"></script>
    <script src="../_static/sql-wasm.js?v=44FE0709"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@7.2.2/dist/handsontable.full.js"></script>
    <script src="../_static/webglinteractive.js?v=2B768384"></script>
    <script src="../_static/FileSaver.min.js?v=8408C997"></script>
    <script src="../_static/Blob.js?v=AEC2447"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.i18n/1.0.5/jquery.i18n.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.i18n/1.0.5/jquery.i18n.emitter.bidi.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.i18n/1.0.5/jquery.i18n.emitter.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.i18n/1.0.5/jquery.i18n.fallbacks.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.i18n/1.0.5/jquery.i18n.messagestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.i18n/1.0.5/jquery.i18n.parser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.i18n/1.0.5/jquery.i18n.language.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega@4.0.0-rc.2/build/vega.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@2.5.0/build/vega-lite.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@3.14.0/build/vega-embed.js"></script>
    <script src="../_static/runestone.js?v=343ECCF5"></script>
    <script src="../_static/jquery-ui-1.10.3.custom.min.js?v=2B07FE4F"></script>
    <script src="../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
    <script src="../_static/jquery-fix.js?v=1226591B"></script>
    <script src="../_static/bootstrap-sphinx.js"></script>
    <script src="../_static/jquery.idle-timer.js?v=E942DAF1"></script>
    <script src="../_static/presenter_mode.js?v=2DF16FB4"></script>
    <script src="../_static/theme.js?v=D899FB97"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="11.2. Memory management" href="memory-management.html" />
    <link rel="prev" title="11. Memory Management" href="index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
<link rel="shortcut icon" href="/cisc187-reader/static/favicon.ico" type="image/ico" />

<script type="text/javascript">
  eBookConfig = {};
  
    eBookConfig.useRunestoneServices = false;
    eBookConfig.host = 'https://daveparillo.github.io/cisc187-reader/' || 'http://127.0.0.1:8000';
    eBookConfig.app = eBookConfig.host+'/cisc187-reader';
    eBookConfig.course = 'cisc187-reader';
    eBookConfig.basecourse = 'cisc187-reader';
    eBookConfig.isLoggedIn = false;
  
  eBookConfig.ajaxURL = eBookConfig.app+'/ajax/';
  eBookConfig.logLevel = 0;
  eBookConfig.loginRequired = false;
  eBookConfig.build_info = "unknown";
  eBookConfig.python3 = true;
  eBookConfig.acDefaultLanguage = 'cpp' ? 'cpp' : 'python'
  eBookConfig.runestone_version = '5.0.8';
  eBookConfig.jobehost = 'https://fierce-ridge-58946.herokuapp.com/http://jobe2.cosc.canterbury.ac.nz';
  eBookConfig.proxyuri_runs = '/jobe/index.php/restapi/runs/';
  eBookConfig.proxyuri_files = '/jobe/index.php/restapi/files/';
  eBookConfig.enable_chatcodes = false ? false : false;


</script>

<!-- Ad Serving Headers Only serve ads to Anonymous Users -->





  </head><body>


<!-- Begin navbar -->
<div id="navbar" class="navbar navbar-default navbar-fixed-top" role="navigation">

  <div class="container">

    <div class="navbar-header">
      <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
      <button type='button' class='navbar-toggle' data-toggle="collapse" data-target=".navbar-ex1-collapse">
        <span class="icon-bar" aria-label="navbar toggle" class="visuallyhidden">toggle navbar</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div>
        
          <a class="brand-logo" style='background: transparent url("../_static/img/logo_small.png") no-repeat 0px 0px;'>&nbsp;<span aria-label="logo" class="visuallyhidden">Runestone Logo</span> </a>
        
        <a class="navbar-brand" href="../index.html" aria-label="index-page">
          
          cisc187-reader
        </a>
      </div>
    </div>



    <div class="navbar-collapse collapse navbar-ex1-collapse">
      <ul class="nav navbar-nav navbar-right" >

        <li class="divider-vertical"></li>


        <!-- social media dropdown -->
        <!-- end social media dropdown -->

        <li class="divider-vertical"></li>

        <!-- search dropdown -->
        <li class="dropdown">
          <a class="dropdown-toggle" href="#" data-toggle="dropdown">
            <i class="glyphicon glyphicon-search" style='opacity:0.9;'><span aria-label="Search" class="visuallyhidden">Search</span></i>
          </a>
          <ul class='dropdown-menu'>
            
                <li><a href='../index.html' aria-label="index-page">Table of Contents</a></li>
            
            <li><a href='../genindex.html'>Book Index</a></li>
            <li class="divider"></li>
            <li style="width: 240px;">
              <form class="navbar-search" style="margin:10px;" action="../search.html" method="get">
                <div class="input-group">
                  <input type="text" class="form-control" name="q" placeholder="Search this book" />
                  <span class="input-group-btn">
                    <button class="btn btn-primary" style="margin:0;" type="submit">
                      <i class="glyphicon glyphicon-search"></i>
                    </button>
                  </span>
                </div><!-- /input-group -->
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
            </li>
          </ul>
        </li>
        <!-- end search dropdown -->

        <li class="divider-vertical"></li>

        
        <li class="divider-vertical"></li>
        <!-- <li id="scratch_ac_link"><a href="javascript:ACFactory.toggleScratchActivecode()">Scratch ActiveCode</a></li> -->

        <!-- <li class="dropdown">             -->
          <li id="scratch_ac_link" class="dropdown"><a href="javascript:ACFactory.toggleScratchActivecode()">
              <i class="glyphicon glyphicon-pencil" style="opacity:0.9;"><span aria-label="Scratch Activecode" class="visuallyhidden">Scratch Activecode</span></i></a></li>
        <!-- </li> -->

        <li class="divider-vertical"></li>

        
      </ul>

      <ul class="nav navbar-nav">
        <li class="divider-vertical"></li>
        
          
          <li class="divider-vertical"></li>
        
        <!-- 
          
  <li id="relations-prev" title="Previous Chapter - <span class="section-number">11. </span>Memory Management" data-toggle="tooltip">
    <a href="index.html" >
      <i class='glyphicon glyphicon-backward' style='opacity:0.9;'></i>
    </a>
  </li>
  
  <li id="relations-next" title='Next Chapter - <span class="section-number">11.2. </span>Memory management' data-toggle="tooltip" >              
    <a href="memory-management.html" >
        <i class='glyphicon glyphicon-forward' style='opacity:0.9;'></i>
    </a>
  </li>
  <li class="divider-vertical"></li>

<script type="text/javascript">
  opts = {'placement':'bottom',
          'selector': '',
          'delay': { show: 100, hide: 50}
         };

  $('#relations-prev').tooltip(opts);
  $('#relations-next').tooltip(opts);
</script>
        -->
        
          <li></li>
        
      </ul>

      </div> <!-- navbar -->







    </div> <!-- container -->
  </div>
</div>


<div class="container" id="continue-reading"></div>

<div class="container" id="main-content" role="main">
  
  <div class="section" id="copying-objects">
<span id="index-0"></span><h1><span class="section-number">11.1. </span>Copying objects<a class="headerlink" href="#copying-objects" title="Permalink to this headline">¶</a></h1>
<p>C++ is one of the few languages that provides precise control
over how memory is managed.
Programmers have choices on how (or if) objects are copied and moved.
Whenever an object is passed by value to a function,
or returned by value from a function, a copy is implicitly performed:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">scores</span><span class="p">;</span>
<span class="k">auto</span> <span class="n">avg</span> <span class="o">=</span> <span class="n">average</span> <span class="p">(</span><span class="n">scores</span><span class="p">);</span>  <span class="c1">// a copy of scores is passed to average</span>
</pre></div>
</div>
<p>Copy operations also occur in range-for loops:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="nl">value</span><span class="p">:</span> <span class="n">scores</span><span class="p">)</span>
</pre></div>
</div>
<p>Each member of <code class="docutils literal notranslate"><span class="pre">scores</span></code> is copied into <code class="docutils literal notranslate"><span class="pre">value</span></code> on each iteration.</p>
<p>Explicit copying can also be performed.
Whenever you have an existing object and use it to initialize
a new or existing object, the copy constructor is called:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">words</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">words</span><span class="p">;</span> <span class="c1">// copy words into w2</span>
</pre></div>
</div>
<p>Both explicit and implicit copies are controlled by
a special constructor called the <em>copy constructor</em>.
Like other constructors,
the copy constructor is a member function with the same name as the class name.
The signature <strong>must</strong> be able to evaluate to this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">class_name</span> <span class="p">(</span> <span class="k">const</span> <span class="n">class_name</span> <span class="o">&amp;</span> <span class="p">);</span>
</pre></div>
</div>
<p>A copy constructor <em>may</em> take other parameters, but it is uncommon.
If there are other parameters, they must all have defaults values defined.
In general,
the default copy constructor generated by the compiler will suffice.
If the default creation is inhibited for any reason,
it is acceptable to explicitly declare the default constructor:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">class_name</span> <span class="p">(</span> <span class="k">const</span> <span class="n">class_name</span> <span class="o">&amp;</span> <span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</pre></div>
</div>
<p>However the default copy constructor is created,
the behavior is the same: each class member is copied, in initialization order.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">A</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">d</span><span class="p">;</span>

  <span class="c1">// user defined default constructor</span>
  <span class="n">A</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="kt">double</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">n</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">d</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
  <span class="p">{</span> <span class="p">}</span>

  <span class="c1">// user defined copy constructor</span>
  <span class="n">A</span><span class="p">(</span><span class="k">const</span> <span class="n">A</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">n</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">n</span><span class="p">),</span> <span class="n">d</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">d</span><span class="p">)</span>
  <span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>In this case, the user defined copy constructor
does what the default constructors would do.
When that is the case, it’s best not to redo the work of the compiler.</p>
<p>When objects manage their own resources,
simple member-wise assignment cannot be used.
Consider the following:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;cctype&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstddef&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>

<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">;</span>

<span class="k">namespace</span> <span class="n">mesa</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">string</span> <span class="p">{</span>
    <span class="k">private</span><span class="o">:</span>
      <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">;</span>
      <span class="kt">size_t</span> <span class="n">sz</span><span class="p">;</span>

    <span class="k">public</span><span class="o">:</span>
      <span class="k">explicit</span> <span class="n">string</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">strlen</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">sz</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sz</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="n">data</span><span class="p">[</span><span class="n">sz</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kt">void</span> <span class="n">upper</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sz</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
         <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">toupper</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="p">}</span>

      <span class="o">~</span><span class="n">string</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">delete</span><span class="p">[]</span> <span class="n">data</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kt">char</span><span class="o">*</span> <span class="n">c_str</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">data</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">};</span>

<span class="p">}</span> <span class="c1">// namespace mesa</span>
</pre></div>
</div>
<p>This class encapsulates an array of characters, providing 4 functions:</p>
<ul class="simple">
<li><p>A one arg constructor that also serves as the default constructor
The constructor allocates memory for the <code class="docutils literal notranslate"><span class="pre">char</span></code> array and copies
the provided string</p></li>
<li><p>A destructor to clean up memory allocated by the constructor</p></li>
<li><p>A function <code class="docutils literal notranslate"><span class="pre">upper</span></code> to transform the entire array to upper case.</p></li>
</ul>
<p>What happens when we use this class?</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mesa</span><span class="o">::</span><span class="n">string</span> <span class="n">hello</span><span class="p">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="p">);</span>
  <span class="n">mesa</span><span class="o">::</span><span class="n">string</span> <span class="n">copy</span> <span class="o">=</span> <span class="n">hello</span><span class="p">;</span>
  <span class="n">copy</span><span class="p">.</span><span class="n">upper</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">hello</span><span class="p">.</span><span class="n">c_str</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This program prints:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">HELLO</span><span class="p">,</span> <span class="n">WORLD</span><span class="o">!</span>
</pre></div>
</div>
<p>Even though we copied <code class="docutils literal notranslate"><span class="pre">hello</span></code>,
changing the case of copy also resulted in changes to the original.
When we copy a value, we expect a <em>cloned object</em>.
A object that in all respects has the same attributes,
but that is separate and distinct.
We <strong>don’t</strong> want changes in one to affect the other.</p>
<p>The default copy behavior is a <em>shallow copy</em>: a literal copying of the bytes
of each member variable.
In the case of our string class, the <code class="docutils literal notranslate"><span class="pre">char*</span></code> is faithfully copied.
When the copy is made, both variables point to the same memory.
To see this copy in action, view it
<a class="reference external" href="http://pythontutor.com/cpp.html#code=%23include%20%3Ccctype%3E%0A%23include%20%3Ccstddef%3E%0A%23include%20%3Ccstring%3E%0A%23include%20%3Ciostream%3E%0A%0Ausing%20std%3A%3Asize_t%3B%0A%0Anamespace%20mesa%20%7B%0A%20%20class%20string%20%7B%0A%20%20%20%20private%3A%0A%20%20%20%20%20%20char*%20data%3B%0A%20%20%20%20%20%20size_t%20sz%3B%0A%0A%20%20%20%20public%3A%0A%20%20%20%20%20%20explicit%20string%28const%20char*%20value%20%3D%20%22%22%29%20%7B%0A%20%20%20%20%20%20%20%20sz%20%3D%20std%3A%3Astrlen%28value%29%20%2B%201%3B%0A%20%20%20%20%20%20%20%20data%20%3D%20new%20char%5Bsz%5D%3B%0A%20%20%20%20%20%20%20%20for%20%28size_t%20i%3D0%3B%20i%20%3C%20sz%3B%20%2B%2Bi%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20data%5Bi%5D%20%3D%20value%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20data%5Bsz-1%5D%20%3D%20'%5C0'%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20void%20upper%28%29%20%7B%0A%20%20%20%20%20%20%20%20for%20%28size_t%20i%3D0%3B%20i%20%3C%20sz%3B%20%2B%2Bi%29%0A%20%20%20%20%20%20%20%20%20%20data%5Bi%5D%20%3D%20std%3A%3Atoupper%28data%5Bi%5D%29%3B%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20~string%28%29%20%7B%0A%20%20%20%20%20%20%20%20delete%5B%5D%20data%3B%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20char*%20c_str%28%29%20%7B%20return%20data%3B%20%7D%0A%20%20%7D%3B%0A%0A%7D%20//%20namespace%20mesa%0Aint%20main%28%29%0A%7B%0A%20%20mesa%3A%3Astring%20hello%28%22Hello,%20world!%22%29%3B%0A%20%20std%3A%3Acout%20%3C%3C%20hello.c_str%28%29%20%3C%3C%20'%5Cn'%3B%0A%20%20mesa%3A%3Astring%20copy%20%3D%20hello%3B%0A%20%20copy.upper%28%29%3B%0A%20%20std%3A%3Acout%20%3C%3C%20hello.c_str%28%29%20%3C%3C%20'%5Cn'%3B%0A%0A%20%20return%200%3B%0A%0A%7D&amp;curInstr=39&amp;mode=display&amp;origin=opt-frontend.js&amp;py=cpp&amp;rawInputLstJSON=%5B%5D">here</a>.</p>
<p>Because there are two pointers to the same data on the free store,
when either is deleted, the free-store memory is recovered.
Consider this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">mesa</span><span class="o">::</span><span class="n">string</span> <span class="n">hello</span><span class="p">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="p">);</span>

<span class="c1">// create a new scope</span>
<span class="p">{</span>
  <span class="n">mesa</span><span class="o">::</span><span class="n">string</span> <span class="n">copy</span> <span class="o">=</span> <span class="n">hello</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">// local variable copy destroyed</span>

<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">hello</span><span class="p">.</span><span class="n">c_str</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>What does the last line print?</p>

    <div data-component="reveal" id="reveal_str_copy_ube"   data-showtitle="Show" data-hidetitle="Hide" >
    <p>There is no way to know for sure.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">copy</span></code> goes out of scope and its destructor is called,
it deletes the memory <code class="docutils literal notranslate"><span class="pre">copy::data</span></code> points to,
but this is the same array <code class="docutils literal notranslate"><span class="pre">hello</span></code> is using.
When <code class="docutils literal notranslate"><span class="pre">hello.c_str()</span></code> is called, undefined behavior is the result.</p>

    </div>
    <p>To see this copy in action, view it
<a class="reference external" href="http://pythontutor.com/cpp.html#code=%23include%20%3Ccctype%3E%0A%23include%20%3Ccstddef%3E%0A%23include%20%3Ccstring%3E%0A%23include%20%3Ciostream%3E%0A%0Ausing%20std%3A%3Asize_t%3B%0A%0Anamespace%20mesa%20%7B%0A%20%20class%20string%20%7B%0A%20%20%20%20private%3A%0A%20%20%20%20%20%20char*%20data%3B%0A%20%20%20%20%20%20size_t%20sz%3B%0A%0A%20%20%20%20public%3A%0A%20%20%20%20%20%20explicit%20string%28const%20char*%20value%20%3D%20%22%22%29%20%7B%0A%20%20%20%20%20%20%20%20sz%20%3D%20std%3A%3Astrlen%28value%29%20%2B%201%3B%0A%20%20%20%20%20%20%20%20data%20%3D%20new%20char%5Bsz%5D%3B%0A%20%20%20%20%20%20%20%20for%20%28size_t%20i%3D0%3B%20i%20%3C%20sz%3B%20%2B%2Bi%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20data%5Bi%5D%20%3D%20value%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20data%5Bsz-1%5D%20%3D%20'%5C0'%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20void%20upper%28%29%20%7B%0A%20%20%20%20%20%20%20%20for%20%28size_t%20i%3D0%3B%20i%20%3C%20sz%3B%20%2B%2Bi%29%0A%20%20%20%20%20%20%20%20%20%20data%5Bi%5D%20%3D%20std%3A%3Atoupper%28data%5Bi%5D%29%3B%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20~string%28%29%20%7B%0A%20%20%20%20%20%20%20%20delete%5B%5D%20data%3B%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20char*%20c_str%28%29%20%7B%20return%20data%3B%20%7D%0A%20%20%7D%3B%0A%0A%7D%20//%20namespace%20mesa%0Aint%20main%28%29%0A%7B%0A%20%20mesa%3A%3Astring%20hello%28%22Hello,%20world!%22%29%3B%0A%20%20//%20create%20a%20new%20scope%0A%20%20%7B%0A%20%20%20%20mesa%3A%3Astring%20copy%20%3D%20hello%3B%0A%20%20%7D%20//%20local%20variable%20copy%20destroyed%0A%0A%20%20std%3A%3Acout%20%3C%3C%20hello.c_str%28%29%20%3C%3C%20'%5Cn'%3B%0A%20%20return%200%3B%0A%7D&amp;curInstr=36&amp;mode=display&amp;origin=opt-frontend.js&amp;py=cpp&amp;rawInputLstJSON=%5B%5D&quot;">here</a>.</p>
<p>Fixing these problems requires writing a custom copy constructor.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">string</span> <span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">sz</span> <span class="o">=</span> <span class="n">other</span><span class="p">.</span><span class="n">sz</span><span class="p">;</span>
  <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">sz</span><span class="p">];</span>
  <span class="n">std</span><span class="o">::</span><span class="n">strcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">other</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Each class member needs to be copied.
The member <code class="docutils literal notranslate"><span class="pre">sz</span></code> can simply be default copied.
It’s the pointer member that needs special treatment:</p>
<ul class="simple">
<li><p>Initialize a new memory block large enough to hold the copy</p></li>
<li><p>Copy each element of the source array into the destination.
This is what <a class="reference external" href="https://en.cppreference.com/w/cpp/string/byte/strcpy">std::strcpy</a> does.</p></li>
</ul>
<p>In contrast to a <em>shallow</em> copy,
this copy is a <strong>deep copy</strong>.
It doesn’t copy the pointer at all.
It makes an entirely new pointer and (deeply)
copies all of the data pointed to by the source pointer to the destination.</p>
<div class="admonition-try-this admonition">
<p class="admonition-title">Try This!</p>
<p>Take the copy constructor provided and rerun the previous
<code class="docutils literal notranslate"><span class="pre">mesa::string</span></code> examples in this section.</p>
</div>
<hr class="docutils" />
<div class="admonition-more-to-explore admonition">
<p class="admonition-title">More to Explore</p>
<ul class="simple">
<li><p>From cppreference.com:</p>
<ul>
<li><p><a class="reference external" href="https://en.cppreference.com/w/cpp/language/copy_constructor">Copy constructors</a></p></li>
</ul>
</li>
</ul>
</div>
</div>


  <div id=scprogresscontainer>
    You have attempted <span id=scprogresstotal></span> of <span id=scprogressposs></span> activities on this page <div id="subchapterprogress"></div>
  </div>
  
      
<ul>
  <li id="relations-prev" style="opacity:0.4" onmouseover="mouseOverPrev()" onmouseout="mouseOutPrev()"class="navLink" title='Previous Section - 11. Memory Management' data-toggle="tooltip">
    <a href="index.html" aria-label="11. Memory Management">
        <div style="background-color: white; border-style:solid; border-color:lightgrey; border-width:2px; width:100px; height:50px">
            <i class='prevNav glyphicon glyphicon-chevron-left'  style="top:50%; transform:translateY(-50%)translateX(-50%); left: 50%; color:black;"></i>
        </div>
    </a>
  </li>
</ul>

  
<ul>
  <li id="relations-next" style="opacity:0.4" onmouseover="mouseOverNext()" onmouseout="mouseOutNext()" class="navLink" title='Next Section - 11.2. Memory management' data-toggle="tooltip" >
    <a href="memory-management.html" aria-label="11.2. Memory management">
      <div style="background-color: white; border-style:solid; border-color:lightgrey; border-width:2px; width:100px; height:50px">
          <i id="relationsNextIcon" class='nextNav glyphicon glyphicon-chevron-right' style="top:50%; transform:translateY(-50%)translateX(-50%); left: 50%; color:black; "></i>
      </div>
    </a>
  </li>
</ul>

<script type="text/javascript">

  $('#relations-prev').tooltip({'placement':'right', 'selector': '', 'delay': { show: 100, hide: 50}});
  $('#relations-next').tooltip({'placement':'left', 'selector': '', 'delay': { show: 100, hide: 50}});

</script>

<script>
	function mouseOverPrev() {
		document.getElementById("relations-prev").style.opacity=1;
	}

	function mouseOutPrev() {
		document.getElementById("relations-prev").style.opacity=0.4;
	}
	function mouseOverNext() {
		document.getElementById("relations-next").style.opacity=1;
	}

	function mouseOutNext() {
		document.getElementById("relations-next").style.opacity=0.4;
	}
</script>
  
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      
      | <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017-2020 Dave Parillo.
      Created using <a href="http://runestoneinteractive.org/">Runestone</a> 5.0.8.
    </p>
  </div>
</footer>




<script> getSwitch(); </script>


  </body>
</html>